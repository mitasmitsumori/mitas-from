<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const structure = params.get("structure");
    const area = parseFloat(params.get("area") || 0);
    const scaffold = parseFloat(params.get("scaffold") || 0);

    const unitPrices = {
      "木造": 33000,
      "RC造": 50000,
      "S造": 33000,
      "軽量鉄骨造": 33000,
      "足場": 600
    };

    const rows = [
      ["解体工事費", area, "㎡", unitPrices[structure] || 0, area * (unitPrices[structure] || 0)],
      ["足場工事費", scaffold, "㎡", unitPrices["足場"], scaffold * unitPrices["足場"]]
    ];

    let total = 0;
    const tbody = document.getElementById("estimateBody");
    rows.forEach(([label, qty, unit, price, amount]) => {
      total += amount;
      const row = `<tr>
        <td>${label}</td>
        <td>${qty}</td>
        <td>${unit}</td>
        <td>${price.toLocaleString()}</td>
        <td>${amount.toLocaleString()}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
    document.getElementById("totalPrice").textContent = total.toLocaleString() + " 円";

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // IPAフォントをBase64で埋め込む部分（簡易例）
      doc.addFileToVFS("ipaexm.ttf", "");
      doc.addFont("ipaexm.ttf", "IPAexMincho", "normal");
      doc.setFont("IPAexMincho");

      doc.text("御見積内訳書", 80, 15);
      doc.autoTable({ html: '#estimateTable', startY: 25 });
      doc.save("見積書.pdf");
    });
  });
</script>
